<ng-container *ngIf="form" [formGroup]="form">
  <div class="row">
    <p>
      <span class="mat-body">12-Hour Time Format</span><br>
      <span class="mat-caption">Display time stamp in 12-hour format.</span>
    </p>
    <div>
      <mat-slide-toggle color="primary" formControlName="time12hFormat"></mat-slide-toggle>
    </div>
  </div>
  <div class="row">
    <p>
      <span class="mat-body">Audio Conversion</span><br>
      <span class="mat-caption">Convert incoming audio files with ffmpeg. Loudness normalization makes all channels sound equally loud (both boosts quiet channels and reduces loud ones to target level).</span>
    </p>
    <mat-form-field floatLabel="auto">
      <mat-select formControlName="audioConversion" placeholder="Audio Conversion">
        <mat-option [value]="0">Disabled</mat-option>
        <mat-option [value]="1">Enabled without normalization</mat-option>
        <mat-option [value]="2">Conservative normalization (-16 LUFS) - Broadcast standard</mat-option>
        <mat-option [value]="3">Standard normalization (-12 LUFS) - Recommended</mat-option>
        <mat-option [value]="4">Aggressive normalization (-10 LUFS) - Dispatcher optimized</mat-option>
        <mat-option [value]="5">Maximum normalization (-8 LUFS) - Very loud</mat-option>
      </mat-select>
      <mat-hint *ngIf="form?.get('audioConversion')?.value >= 2" style="color: #666; font-size: 0.85em; margin-top: 8px;">
        Normalization equalizes volume across all channels. Louder settings (-12 to -8 LUFS) boost quiet channels more and reduce loud channels more to maintain consistency.
      </mat-hint>
    </mat-form-field>
  </div>
  <div class="row">
    <p>
      <span class="mat-body">Auto Populate</span><br>
      <span class="mat-caption">Globaly allows the automatic creation of unconfigured systems and
                talkgroups.</span>
    </p>
    <div>
      <mat-slide-toggle color="primary" formControlName="autoPopulate"></mat-slide-toggle>
    </div>
  </div>
  <div class="row">
    <p>
      <span class="mat-body">Default System Delay</span><br>
      <span class="mat-caption">
                Default stream delay in MINUTES to apply to all systems and talkgroups unless they have their own specific delay values set. This delays live audio streaming to clients. Set to 0 to disable.
            </span>
    </p>
    <mat-form-field>
      <input type="number" min="0" step="1" matInput formControlName="defaultSystemDelay" placeholder="Delay in minutes">
      <mat-error *ngIf="form?.get('defaultSystemDelay')?.hasError('required')">
        Default delay is required
      </mat-error>
      <mat-error *ngIf="form?.get('defaultSystemDelay')?.hasError('min')">
        Default delay must be 0 or greater
      </mat-error>
    </mat-form-field>
  </div>
  <div class="row">
    <p>
      <span class="mat-body">Branding Label</span><br>
      <span class="mat-caption">A simple line of text displayed above the main screen to help identify the Thinline
                Radio instance.</span>
    </p>
    <mat-form-field floatLabel="auto">
      <input type="text" matInput formControlName="branding" placeholder="Branding">
    </mat-form-field>
  </div>
  <div class="row">
    <p>
      <span class="mat-body">Favicon</span><br>
      <span class="mat-caption">Custom favicon for the web application. Recommended: PNG, ICO, or SVG format.</span>
    </p>
    <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
      <input type="file" #faviconInput accept="image/png,image/jpeg,image/jpg,image/svg+xml,image/x-icon" 
             (change)="onFaviconSelected($event)" style="display: none;">
      <button mat-raised-button type="button" (click)="faviconInput.click()">
        <mat-icon>upload</mat-icon>
        {{ hasFavicon() ? 'Change' : 'Upload' }} Favicon
      </button>
      <button mat-raised-button type="button" color="warn" *ngIf="hasFavicon()" (click)="removeFavicon()">
        <mat-icon>delete</mat-icon>
        Remove
      </button>
      <div *ngIf="hasFavicon()" style="max-width: 64px; max-height: 64px; border: 1px solid #ddd; padding: 5px; border-radius: 4px; background: white;">
        <img [src]="getFaviconPreview()" style="max-width: 100%; max-height: 100%; display: block;">
      </div>
    </div>
  </div>
  <div class="row">
    <p>
      <span class="mat-body">Dimmer Delay</span><br>
      <span class="mat-caption">Delay in milliseconds before turning off the screen backlight when
                inactive.</span>
    </p>
    <mat-form-field>
      <input type="number" min="0" step="1" matInput formControlName="dimmerDelay">
      <mat-error *ngIf="form?.get('dimmerDelay')?.hasError('required')">
        Dimmer delay is required
      </mat-error>
      <mat-error *ngIf="form?.get('dimmerDelay')?.hasError('min')">
        Dimmer delay is invalid
      </mat-error>
    </mat-form-field>
  </div>
  <div class="row">
    <p>
      <span class="mat-body">Disable Duplicate Call Detection</span><br>
      <span class="mat-caption">Completely disable duplicate call detection.</span>
    </p>
    <div>
      <mat-slide-toggle color="primary" formControlName="disableDuplicateDetection"></mat-slide-toggle>
    </div>
  </div>
  
  <!-- Show mode selector when duplicate detection is enabled -->
  <div class="row" *ngIf="!form.get('disableDuplicateDetection')?.value">
    <p>
      <span class="mat-body">Duplicate Detection Mode</span><br>
      <span class="mat-caption">
        <strong>Legacy:</strong> Time-based detection only (current behavior).<br>
        <strong>Advanced:</strong> Site-priority with frequency validation and API key control.
      </span>
    </p>
    <mat-form-field>
      <mat-select formControlName="duplicateDetectionMode">
        <mat-option value="legacy">Legacy (Time-based)</mat-option>
        <mat-option value="advanced">Advanced (Site/Frequency/API Key)</mat-option>
      </mat-select>
    </mat-form-field>
  </div>

  <!-- Legacy Mode Time Frame (always shown) -->
  <div class="row" *ngIf="!form.get('disableDuplicateDetection')?.value">
    <p>
      <span class="mat-body">Legacy Mode Time Frame</span><br>
      <span class="mat-caption">
        Time window in milliseconds (±) for legacy duplicate detection.
        Rejects calls with same system/talkgroup within this window.
        <span *ngIf="form.get('duplicateDetectionMode')?.value === 'advanced'">
          Also used as fallback when advanced mode can't be applied.
        </span>
      </span>
    </p>
    <mat-form-field>
      <input type="number" min="0" step="1" matInput 
             formControlName="duplicateDetectionTimeFrame"
             placeholder="Milliseconds">
      <mat-error *ngIf="form?.get('duplicateDetectionTimeFrame')?.hasError('required')">
        Time frame is required
      </mat-error>
      <mat-error *ngIf="form?.get('duplicateDetectionTimeFrame')?.hasError('min')">
        Time frame must be 0 or greater
      </mat-error>
    </mat-form-field>
  </div>

  <!-- Advanced Mode Time Frame (only shown when advanced mode is selected) -->
  <div class="row" *ngIf="!form.get('disableDuplicateDetection')?.value && form.get('duplicateDetectionMode')?.value === 'advanced'">
    <p>
      <span class="mat-body">Advanced Mode Time Frame</span><br>
      <span class="mat-caption">
        Time window in milliseconds (±) for advanced site/frequency-based duplicate detection.
        Used to find conflicting calls from preferred/secondary sites.
      </span>
    </p>
    <mat-form-field>
      <input type="number" min="0" step="1" matInput 
             formControlName="advancedDetectionTimeFrame"
             placeholder="Milliseconds">
      <mat-error *ngIf="form?.get('advancedDetectionTimeFrame')?.hasError('required')">
        Time frame is required
      </mat-error>
      <mat-error *ngIf="form?.get('advancedDetectionTimeFrame')?.hasError('min')">
        Time frame must be 0 or greater
      </mat-error>
    </mat-form-field>
  </div>
  <div class="row">
    <p>
      <span class="mat-body">Email Support</span><br>
      <span class="mat-caption">Email address where users can write to to get support.</span>
    </p>
    <mat-form-field floatLabel="auto">
      <input type="text" matInput formControlName="email" placeholder="Email">
    </mat-form-field>
  </div>
  <div class="row">
    <p>
      <span class="mat-body">Keypad Beep Style</span><br>
      <span class="mat-caption">Provide audio feedback when pressing buttons.</span>
    </p>
    <mat-form-field floatLabel="auto">
      <mat-select formControlName="keypadBeeps" placeholder="Style">
        <mat-option value="uniden">Uniden</mat-option>
        <mat-option value="whistler">Whistler</mat-option>
      </mat-select>
    </mat-form-field>
  </div>
  <div class="row">
    <p>
      <span class="mat-body">Max Clients</span><br>
      <span class="mat-caption">Max number of simultaneous clients.</span>
    </p>
    <mat-form-field>
      <input type="number" min="0" step="1" matInput formControlName="maxClients">
      <mat-error *ngIf="form?.get('maxClients')?.hasError('required')">
        Max clients is required
      </mat-error>
      <mat-error *ngIf="form?.get('maxClients')?.hasError('min')">
        Max clients is invalid
      </mat-error>
    </mat-form-field>
  </div>
  <div class="row">
    <p>
      <span class="mat-body">Playback Mode Goes Live</span><br>
      <span class="mat-caption">Playback mode changes to live stream mode when the search list is
                exhausted.</span>
    </p>
    <div>
      <mat-slide-toggle color="primary" formControlName="playbackGoesLive"></mat-slide-toggle>
    </div>
  </div>
  <div class="row">
    <p>
      <span class="mat-body">Prune Days</span><br>
      <span class="mat-caption">Prune the database for data older than the specified number of days. Set to 0 to
                disable.</span>
    </p>
    <mat-form-field>
      <input type="number" min="0" step="1" matInput formControlName="pruneDays">
      <mat-error *ngIf="form?.get('pruneDays')?.hasError('required')">
        Prune days is required
      </mat-error>
      <mat-error *ngIf="form?.get('pruneDays')?.hasError('min')">
        Prune days is invalid
      </mat-error>
    </mat-form-field>
  </div>
  <div class="row">
    <p>
      <span class="mat-body">Show Listeners Count</span><br>
      <span class="mat-caption">Show listeners count on main screen.</span>
    </p>
    <div>
      <mat-slide-toggle color="primary" formControlName="showListenersCount"></mat-slide-toggle>
    </div>
  </div>
  <div class="row">
    <p>
      <span class="mat-body">Sort Talkgroups</span><br>
      <span class="mat-caption">Automatically sort talkgroups by their id.</span>
    </p>
    <div>
      <mat-slide-toggle color="primary" formControlName="sortTalkgroups"></mat-slide-toggle>
    </div>
  </div>

  <!-- Radio Reference Configuration -->
  <div class="row">
    <p>
      <span class="mat-body">Radio Reference Integration</span><br>
      <span class="mat-caption">Use your username (not email) and your Radio Reference password, click Save, then go to Tools → Radio Reference Import and click Test Connection.</span>
    </p>
    <div>
      <mat-slide-toggle color="primary" formControlName="radioReferenceEnabled"></mat-slide-toggle>
    </div>
  </div>

  <!-- Show logged-in state when credentials exist and not editing -->
  <div class="row" *ngIf="form?.get('radioReferenceEnabled')?.value && isRadioReferenceLoggedIn && !isEditingRadioReference">
    <p>
      <span class="mat-body">Radio Reference Account</span><br>
      <span class="mat-caption">Logged in as: <strong>{{ form.get('radioReferenceUsername')?.value }}</strong></span>
    </p>
    <div style="display: flex; gap: 8px;">
      <button mat-raised-button color="primary" (click)="editRadioReferenceLogin()">
        <mat-icon>edit</mat-icon>
        Edit Login
      </button>
      <button mat-raised-button color="warn" (click)="removeRadioReferenceAccount()">
        <mat-icon>delete</mat-icon>
        Remove Account
      </button>
    </div>
  </div>

  <!-- Show login form when enabled but not logged in, or when editing -->
  <div class="row" *ngIf="form?.get('radioReferenceEnabled')?.value && shouldShowLoginForm">
    <p>
      <span class="mat-body">Radio Reference Username</span><br>
      <span class="mat-caption">Your RadioReference.com username for API access.</span>
    </p>
    <mat-form-field floatLabel="auto">
      <input type="text" matInput formControlName="radioReferenceUsername" placeholder="Username">
      <mat-error *ngIf="form?.get('radioReferenceUsername')?.hasError('required')">
        Username is required when Radio Reference is enabled
      </mat-error>
    </mat-form-field>
  </div>

  <div class="row" *ngIf="form?.get('radioReferenceEnabled')?.value && shouldShowLoginForm">
    <p>
      <span class="mat-body">Radio Reference Password</span><br>
      <span class="mat-caption">Your RadioReference.com password for API access.</span>
    </p>
    <mat-form-field floatLabel="auto">
      <input type="password" matInput formControlName="radioReferencePassword" placeholder="Password">
      <mat-error *ngIf="form?.get('radioReferencePassword')?.hasError('required')">
        Password is required when Radio Reference is enabled
      </mat-error>
    </mat-form-field>
  </div>

  <!-- Show cancel button when editing -->
  <div class="row" *ngIf="form?.get('radioReferenceEnabled')?.value && isEditingRadioReference">
    <div style="display: flex; gap: 8px;">
      <button mat-stroked-button (click)="cancelEditRadioReference()">
        <mat-icon>cancel</mat-icon>
        Cancel Edit
      </button>
    </div>
  </div>

  <!-- Transcription Configuration -->
  <div class="row" style="margin-top: 24px; padding-top: 24px; border-top: 2px solid #e0e0e0;">
    <h3 style="width: 100%; margin: 0 0 16px 0;">Transcription Settings</h3>
  </div>

  <div class="row">
    <p>
      <span class="mat-body">Transcription Enabled</span><br>
      <span class="mat-caption">Enable transcription for calls. When enabled, calls will be transcribed if tone detected or user alerts are enabled.</span>
    </p>
    <div>
      <mat-slide-toggle color="primary" formControlName="transcriptionEnabled"></mat-slide-toggle>
    </div>
  </div>

  <div class="row" *ngIf="form?.get('transcriptionEnabled')?.value" formGroupName="transcriptionConfig">
    <p>
      <span class="mat-body">Transcription Provider</span><br>
      <span class="mat-caption">Select the transcription provider to use. OpenAI-compatible API supports Whisper, Qwen3-ASR, or official OpenAI servers.</span>
    </p>
    <mat-form-field floatLabel="auto">
      <mat-select formControlName="provider" placeholder="Provider">
        <mat-option value="whisper-api">OpenAI-Compatible API (Whisper / Qwen3-ASR / OpenAI)</mat-option>
        <mat-option value="azure">Azure Speech Services</mat-option>
        <mat-option value="google">Google Cloud Speech-to-Text</mat-option>
        <mat-option value="assemblyai">AssemblyAI</mat-option>
      </mat-select>
    </mat-form-field>
  </div>

  <div class="row" *ngIf="form?.get('transcriptionEnabled')?.value && form?.get('transcriptionConfig')?.get('provider')?.value === 'whisper-api'" formGroupName="transcriptionConfig">
    <p>
      <span class="mat-body">API Server URL</span><br>
      <span class="mat-caption">Base URL of OpenAI-compatible server. Supports local Whisper (http://localhost:8000), local Qwen3-ASR (http://localhost:8000), or official OpenAI API (https://api.openai.com). Server must provide /v1/audio/transcriptions endpoint.</span>
    </p>
    <mat-form-field floatLabel="auto">
      <input type="text" matInput formControlName="whisperAPIURL" placeholder="http://localhost:8000">
    </mat-form-field>
  </div>

  <!-- Info box about Whisper vs Qwen -->
  <div class="row" *ngIf="form?.get('transcriptionEnabled')?.value && form?.get('transcriptionConfig')?.get('provider')?.value === 'whisper-api'" style="margin: 8px 0;">
    <div style="background-color: #e3f2fd; border-left: 4px solid #2196f3; padding: 12px 16px; border-radius: 4px; width: 100%;">
      <p style="margin: 0 0 8px 0; font-weight: 600; color: #1976d2;">
        <mat-icon style="vertical-align: middle; font-size: 18px; width: 18px; height: 18px; margin-right: 4px;">info</mat-icon>
        Local ASR Servers - Whisper vs Qwen3-ASR
      </p>
      <p style="margin: 0; font-size: 13px; line-height: 1.5;">
        <strong>Whisper:</strong> Excellent general accuracy, widely tested, best for English-primary dispatch.<br>
        <strong>Qwen3-ASR:</strong> State-of-the-art multilingual support (30 languages + 22 Chinese dialects), excellent for singing/music, competitive accuracy. Both support prompting and automatic tone removal.
      </p>
    </div>
  </div>

  <div class="row" *ngIf="form?.get('transcriptionEnabled')?.value && form?.get('transcriptionConfig')?.get('provider')?.value === 'whisper-api'" formGroupName="transcriptionConfig">
    <p>
      <span class="mat-body">API Key</span><br>
      <span class="mat-caption">API key if your server requires authentication. Optional for local servers, required for official OpenAI API.</span>
    </p>
    <mat-form-field floatLabel="auto">
      <input type="text" matInput formControlName="whisperAPIKey" placeholder="(optional)">
    </mat-form-field>
  </div>

  <div class="row" *ngIf="form?.get('transcriptionEnabled')?.value && form?.get('transcriptionConfig')?.get('provider')?.value === 'azure'" formGroupName="transcriptionConfig">
    <p>
      <span class="mat-body">Azure Subscription Key</span><br>
      <span class="mat-caption">Your Azure Speech Services subscription key. Get it from the Azure Portal under your Speech resource.</span>
    </p>
    <mat-form-field floatLabel="auto">
      <input type="password" matInput formControlName="azureKey" placeholder="Enter Azure subscription key">
    </mat-form-field>
  </div>

  <div class="row" *ngIf="form?.get('transcriptionEnabled')?.value && form?.get('transcriptionConfig')?.get('provider')?.value === 'azure'" formGroupName="transcriptionConfig">
    <p>
      <span class="mat-body">Azure Region</span><br>
      <span class="mat-caption">Azure region where your Speech resource is located (e.g., "eastus", "westus2", "westeurope").</span>
    </p>
    <mat-form-field floatLabel="auto">
      <input type="text" matInput formControlName="azureRegion" placeholder="eastus">
    </mat-form-field>
  </div>

  <div class="row" *ngIf="form?.get('transcriptionEnabled')?.value && form?.get('transcriptionConfig')?.get('provider')?.value === 'google'" formGroupName="transcriptionConfig">
    <p>
      <span class="mat-body">Google Cloud API Key</span><br>
      <span class="mat-caption">Your Google Cloud Speech-to-Text API key. You can use either an API key or service account credentials.</span>
    </p>
    <mat-form-field floatLabel="auto">
      <input type="password" matInput formControlName="googleAPIKey" placeholder="Enter Google Cloud API key">
    </mat-form-field>
  </div>

  <div class="row" *ngIf="form?.get('transcriptionEnabled')?.value && form?.get('transcriptionConfig')?.get('provider')?.value === 'google'" formGroupName="transcriptionConfig">
    <p>
      <span class="mat-body">Google Service Account JSON (Alternative to API Key)</span><br>
      <span class="mat-caption">Paste your Google Cloud service account JSON credentials here. This is an alternative to using an API key. Note: OAuth2 token generation from credentials is not yet implemented, so API key is recommended.</span>
    </p>
    <mat-form-field floatLabel="auto" style="width: 100%;">
      <textarea matInput formControlName="googleCredentials" placeholder='{"type": "service_account", ...}' rows="5"></textarea>
    </mat-form-field>
  </div>

  <div class="row" *ngIf="form?.get('transcriptionEnabled')?.value && form?.get('transcriptionConfig')?.get('provider')?.value === 'assemblyai'" formGroupName="transcriptionConfig">
    <p>
      <span class="mat-body">AssemblyAI API Key</span><br>
      <span class="mat-caption">Your AssemblyAI API key. Get it from https://www.assemblyai.com/app/account</span>
    </p>
    <mat-form-field floatLabel="auto">
      <input type="password" matInput formControlName="assemblyAIKey" placeholder="Enter AssemblyAI API key">
    </mat-form-field>
  </div>

  <div class="row" *ngIf="form?.get('transcriptionEnabled')?.value && form?.get('transcriptionConfig')?.get('provider')?.value === 'assemblyai'" formGroupName="transcriptionConfig">
    <p>
      <span class="mat-body">Word Boost / Keyterms (AssemblyAI)</span><br>
      <span class="mat-caption">Enter words or phrases (one per line) to improve recognition accuracy. Maximum 100 terms, each up to 50 characters. Examples: unit names, technical terms, proper names. Leave empty for default behavior.</span>
    </p>
    <mat-form-field floatLabel="auto" style="width: 100%;">
      <textarea matInput formControlName="assemblyAIWordBoost" placeholder="ENGINE&#10;TRUCK&#10;LADDER&#10;RESCUE" rows="4"></textarea>
      <mat-hint>One term per line. Terms longer than 50 characters will be ignored.</mat-hint>
    </mat-form-field>
  </div>


  <div class="row" *ngIf="form?.get('transcriptionEnabled')?.value" formGroupName="transcriptionConfig">
    <p>
      <span class="mat-body">Language</span><br>
      <span class="mat-caption">Language code for transcription (e.g., "en" for English, "auto" for auto-detect).</span>
    </p>
    <mat-form-field floatLabel="auto">
      <input type="text" matInput formControlName="language" placeholder="en">
    </mat-form-field>
  </div>

  <div class="row" *ngIf="form?.get('transcriptionEnabled')?.value && (form?.get('transcriptionConfig')?.get('provider')?.value === 'whisper-api' || !form?.get('transcriptionConfig')?.get('provider')?.value)" formGroupName="transcriptionConfig">
    <p>
      <span class="mat-body">Custom Prompt / Context</span><br>
      <span class="mat-caption">Optional prompt to guide transcription with custom terminology, unit names, formatting preferences, etc. Works with Whisper (as "prompt") and Qwen3-ASR (as "context"). Example: "Fire/EMS dispatch radio. Units: ENGINE, TRUCK, LADDER, QUINT, RESCUE, SQUAD, MEDIC AMBULANCE. Radio channels: VECC FIRE #, CITY FIRE #."</span>
    </p>
    <mat-form-field floatLabel="auto" style="width: 100%;">
      <textarea matInput formControlName="prompt" placeholder="Enter custom prompt to guide transcription..." rows="4"></textarea>
      <mat-hint>Leave empty for default behavior. Compatible with both Whisper and Qwen3-ASR.</mat-hint>
    </mat-form-field>
  </div>


  <div class="row" *ngIf="form?.get('transcriptionEnabled')?.value" formGroupName="transcriptionConfig">
    <p>
      <span class="mat-body">Minimum Call Duration (seconds)</span><br>
      <span class="mat-caption">Skip transcription for calls shorter than this duration. Set to 0 to transcribe all calls. Useful to avoid transcribing very short/test transmissions.</span>
    </p>
    <mat-form-field floatLabel="auto">
      <input type="number" min="0" step="0.5" matInput formControlName="minCallDuration" placeholder="0">
      <mat-hint>0 = transcribe all calls</mat-hint>
    </mat-form-field>
  </div>

  <div class="row" *ngIf="form?.get('transcriptionEnabled')?.value" formGroupName="transcriptionConfig">
    <p>
      <span class="mat-body">Worker Pool Size (Transcription Threads)</span><br>
      <span class="mat-caption">
        Number of concurrent transcription workers. Higher values process calls faster but require more VRAM/resources.
        <br><br>
        <strong style="color: #f57c00;">⚠️ WARNING:</strong> For Whisper API (local Whisper), using more than 1 worker may cause transcription failures if your system doesn't have sufficient VRAM. 
        <strong>Recommended: Start with 1 worker and increase only if you have 8GB+ VRAM and experience no failures.</strong>
        <br><br>
        Cloud providers (Azure, Google, AssemblyAI) can typically handle 5+ workers without issues.
      </span>
    </p>
    <mat-form-field floatLabel="auto">
      <input type="number" min="1" max="10" step="1" matInput formControlName="workerPoolSize" placeholder="1">
      <mat-hint *ngIf="form?.get('transcriptionConfig')?.get('provider')?.value === 'whisper-api' || !form?.get('transcriptionConfig')?.get('provider')?.value">
        Whisper API: 1 worker recommended (increase only if you have sufficient VRAM)
      </mat-hint>
      <mat-hint *ngIf="form?.get('transcriptionConfig')?.get('provider')?.value !== 'whisper-api' && form?.get('transcriptionConfig')?.get('provider')?.value">
        Cloud providers: 3-5 workers recommended
      </mat-hint>
    </mat-form-field>
  </div>

  <div class="row" *ngIf="form?.get('transcriptionEnabled')?.value" formGroupName="transcriptionConfig">
    <p>
      <span class="mat-body">Hallucination Patterns</span><br>
      <span class="mat-caption">Phrases that should be removed from transcripts (case-insensitive). Whisper may hallucinate common phrases from tone-only audio. Add one pattern per line. Example: "THE BELL IS INVITED TO SOUND THREE TIMES"</span>
    </p>
    <mat-form-field floatLabel="auto" style="width: 100%;">
            <textarea
              matInput
              formControlName="hallucinationPatterns"
              placeholder="Enter patterns to remove, one per line"
              rows="4"
              style="font-family: monospace; font-size: 12px;"
            ></textarea>
      <mat-hint>One pattern per line. These will be removed from all transcripts before processing.</mat-hint>
    </mat-form-field>
  </div>

  <div class="row" *ngIf="form?.get('transcriptionEnabled')?.value" formGroupName="transcriptionConfig">
    <p>
      <span class="mat-body">Hallucination Auto-Detection</span><br>
      <span class="mat-caption">
                <strong>What it does:</strong> Whisper sometimes "hallucinates" phrases when transcribing tone-only audio (e.g., "THE BELL IS INVITED TO SOUND THREE TIMES"). This system automatically detects these fake phrases by tracking which transcripts pass vs fail voice detection.<br><br>
                <strong>Modes:</strong><br>
                • <strong>Off</strong> - Only use manually entered patterns below (safest, most predictable)<br>
                • <strong>Manual</strong> - System suggests suspicious phrases for your review and approval<br>
                • <strong>Auto</strong> - System automatically adds high-confidence hallucinations to filter (hands-off, but still safe)
            </span>
    </p>
    <mat-form-field floatLabel="auto">
      <mat-select formControlName="hallucinationDetectionMode" placeholder="Detection Mode">
        <mat-option value="off">Off (Manual Patterns Only)</mat-option>
        <mat-option value="manual">Manual (Review & Approve)</mat-option>
        <mat-option value="auto">Auto (High-Confidence Auto-Add)</mat-option>
      </mat-select>
    </mat-form-field>
  </div>

  <div class="row" *ngIf="form?.get('transcriptionEnabled')?.value && form?.get('transcriptionConfig')?.get('hallucinationDetectionMode')?.value !== 'off'" formGroupName="transcriptionConfig">
    <p>
      <span class="mat-body">Minimum Rejected Occurrences</span><br>
      <span class="mat-caption">
                <strong>How it works:</strong> The system tracks ALL transcribed calls. Each transcript is classified as "accepted" (contains real voice/dispatch) or "rejected" (failed voice detection - could be tones, static, short clips, or hallucinations).<br><br>
                <strong>This setting:</strong> How many times a phrase must appear in REJECTED transcripts before being flagged as a hallucination.<br><br>
                <strong>What gets rejected?</strong> Any call that fails voice detection:<br>
                • Pure tone audio (no voice)<br>
                • Very short audio clips (< 8 words)<br>
                • Garbled or static-heavy audio<br>
                • Background noise transcribed as words<br>
                • Whisper hallucinations<br><br>
                <strong>What about mixed calls?</strong> If a call has ANY real dispatch content, the ENTIRE transcript is marked "accepted" and tracked as legitimate. This protects phrases from being falsely flagged.<br><br>
                <strong>Safety Guarantees:</strong><br>
                ✓ Works on ALL transcribed calls (not just tone-detected calls)<br>
                ✓ Phrase must appear in at least N rejected transcripts<br>
                ✓ Phrase must NEVER appear in accepted transcripts (even once disqualifies it)<br>
                ✓ Must appear on 2+ different radio systems<br>
                ✓ Must NOT contain emergency vocabulary<br>
                ✓ Must have confidence score 6.0+<br><br>
                <strong>Recommendation:</strong> Start with 5-10. Higher = slower detection but fewer false positives.
            </span>
    </p>
    <mat-form-field floatLabel="auto">
      <input type="number" min="1" step="1" matInput formControlName="hallucinationMinOccurrences" placeholder="5">
      <mat-hint>Default: 5 occurrences in rejected transcripts (from any type of call)</mat-hint>
    </mat-form-field>
  </div>

  <!-- Alert Retention -->
  <div class="row" style="margin-top: 24px; padding-top: 24px; border-top: 2px solid #e0e0e0;">
    <h3 style="width: 100%; margin: 0 0 16px 0;">Alert Settings</h3>
  </div>

  <div class="row">
    <p>
      <span class="mat-body">Alert Retention Days</span><br>
      <span class="mat-caption">Number of days to keep alerts in the database before automatic cleanup. Set to 0 to disable cleanup.</span>
    </p>
    <mat-form-field floatLabel="auto">
      <input type="number" min="0" step="1" matInput formControlName="alertRetentionDays" placeholder="30">
    </mat-form-field>
  </div>

  <!-- Push Notifications -->
  <div class="row" style="margin-top: 24px; padding-top: 24px; border-top: 2px solid #e0e0e0;">
    <h3 style="width: 100%; margin: 0 0 16px 0;">Push Notification Settings</h3>
    <p style="width: 100%; margin: 0 0 16px 0; color: #666; font-size: 14px;">
      Get a push notification API key and register your server so users can see it in the mobile app.
    </p>
  </div>

  <div class="row">
    <p>
      <span class="mat-body">Relay Server URL</span><br>
      <span class="mat-caption">URL of your push notification relay server (hardcoded).</span>
    </p>
    <mat-form-field floatLabel="auto">
      <input type="text" matInput formControlName="relayServerURL" [readonly]="true" [value]="'https://tlradioserver.thinlineds.com'" placeholder="https://tlradioserver.thinlineds.com">
    </mat-form-field>
  </div>

  <div class="row">
    <p>
      <span class="mat-body">Relay Server API Key</span><br>
      <span class="mat-caption">API key for authenticating with the relay server. Click the key icon to request one, the edit icon to update your existing registration, or the restore icon to recover a lost API key.</span>
    </p>
    <mat-form-field floatLabel="auto" style="width: 100%;">
      <input type="password" matInput formControlName="relayServerAPIKey" placeholder="Enter your relay server API key">
      <button mat-icon-button matSuffix type="button" (click)="recoverRelayAPIKey()" matTooltip="Recover lost API key" style="margin-right: 5px;">
        <mat-icon>restore</mat-icon>
      </button>
      <button mat-icon-button matSuffix type="button" (click)="editRelayAPIKey()" [matTooltip]="hasRelayAPIKey() ? 'Edit API key details' : 'Request API key from relay server'">
        <mat-icon>{{ hasRelayAPIKey() ? 'edit' : 'vpn_key' }}</mat-icon>
      </button>
    </mat-form-field>
  </div>

  <div class="row">
    <p>
      <span class="mat-body">Cloudflare Turnstile (CAPTCHA)</span><br>
      <span class="mat-caption">Enable Cloudflare Turnstile for user registration, login, and group admin login to prevent bots.</span>
    </p>
    <div>
      <mat-slide-toggle color="primary" formControlName="turnstileEnabled"></mat-slide-toggle>
    </div>
  </div>

  <div class="row" *ngIf="form?.get('turnstileEnabled')?.value">
    <p>
      <span class="mat-body">Turnstile Site Key</span><br>
      <span class="mat-caption">Your public site key from Cloudflare Turnstile.</span>
    </p>
    <mat-form-field floatLabel="auto">
      <input type="text" matInput formControlName="turnstileSiteKey" placeholder="0x4AAAAAAC...">
    </mat-form-field>
  </div>

  <div class="row" *ngIf="form?.get('turnstileEnabled')?.value">
    <p>
      <span class="mat-body">Turnstile Secret Key</span><br>
      <span class="mat-caption">Your private secret key from Cloudflare Turnstile.</span>
    </p>
    <mat-form-field floatLabel="auto">
      <input type="password" matInput formControlName="turnstileSecretKey" placeholder="0x4AAAAAAC...">
    </mat-form-field>
  </div>
</ng-container>
