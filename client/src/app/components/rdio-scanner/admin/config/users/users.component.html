<div class="users-container">
    <div class="row top">
        <p class="mat-body">Manage registered users. You can view user details, resend verification emails, invite users, and delete users.</p>
        <div>
            <button type="button" mat-raised-button color="primary" (click)="openCreateUserDialog()">
                <mat-icon>person_add</mat-icon>
                Create User
            </button>
            <button type="button" mat-button color="primary" (click)="openInviteDialog()">
                <mat-icon>mail</mat-icon>
                Invite User
            </button>
            <button type="button" mat-button color="accent" (click)="refreshUsers()" [disabled]="loading">
                <mat-icon>refresh</mat-icon>
                Refresh
            </button>
        </div>
    </div>

    <!-- Search Box -->
    <div class="search-container" *ngIf="!loading && !error && users.length > 0">
        <mat-form-field appearance="outline" class="search-field">
            <mat-label>Search by name, email, or group</mat-label>
            <input matInput type="text" [(ngModel)]="searchText" (ngModelChange)="onSearchChange()" placeholder="Enter name, email, or group...">
            <mat-icon matPrefix>search</mat-icon>
            <button mat-icon-button matSuffix *ngIf="searchText" (click)="clearSearch()" type="button">
                <mat-icon>clear</mat-icon>
            </button>
        </mat-form-field>
        <div class="search-results-info" *ngIf="searchText">
            <span class="mat-body-2">Showing {{ filteredUsers.length }} of {{ users.length }} users</span>
        </div>
    </div>

    <div *ngIf="loading" class="loading-container">
        <mat-spinner diameter="40"></mat-spinner>
        <p class="mat-body">Loading users...</p>
    </div>

    <div *ngIf="error" class="error-container">
        <mat-icon color="warn">error</mat-icon>
        <p class="mat-body">{{ error }}</p>
        <button type="button" mat-button color="primary" (click)="loadUsers()">Retry</button>
    </div>

    <div *ngIf="!loading && !error && users.length === 0" class="no-users-container">
        <mat-icon>person_off</mat-icon>
        <p class="mat-body">No users registered yet</p>
    </div>

    <mat-accordion displayMode="flat" *ngIf="!loading && !error && users.length > 0">
        <mat-expansion-panel *ngFor="let user of paginatedUsers">
            <mat-expansion-panel-header>
                <mat-panel-title>
                    <mat-icon>person</mat-icon>
                    <span class="user-name-email">
                        <strong>{{ user.firstName }} {{ user.lastName }}</strong>
                        <span class="email-text">{{ user.email }}</span>
                    </span>
                    <mat-chip [color]="getVerificationStatusColor(user)" selected>
                        {{ getVerificationStatus(user) }}
                    </mat-chip>
                    <mat-chip *ngIf="getGroupName(user.userGroupId)" color="accent" selected>
                        <mat-icon>group</mat-icon>
                        {{ getGroupName(user.userGroupId) }}
                    </mat-chip>
                </mat-panel-title>
            </mat-expansion-panel-header>

            <div class="user-details">
                <!-- Edit Form (shown when editing) -->
                <form [formGroup]="editForm" *ngIf="editingUser && editingUser.id === user.id" class="edit-form">
                    <div class="form-row">
                        <mat-form-field appearance="outline" class="full-width">
                            <mat-label>Email</mat-label>
                            <input matInput type="email" formControlName="email" required>
                            <mat-error *ngIf="editForm.get('email')?.hasError('required')">Email is required</mat-error>
                            <mat-error *ngIf="editForm.get('email')?.hasError('email')">Please enter a valid email</mat-error>
                        </mat-form-field>
                    </div>

                    <div class="form-row">
                        <mat-form-field appearance="outline" class="half-width">
                            <mat-label>First Name</mat-label>
                            <input matInput type="text" formControlName="firstName" required>
                            <mat-error *ngIf="editForm.get('firstName')?.hasError('required')">First name is required</mat-error>
                        </mat-form-field>

                        <mat-form-field appearance="outline" class="half-width">
                            <mat-label>Last Name</mat-label>
                            <input matInput type="text" formControlName="lastName" required>
                            <mat-error *ngIf="editForm.get('lastName')?.hasError('required')">Last name is required</mat-error>
                        </mat-form-field>
                    </div>

                    <div class="form-row">
                        <mat-form-field appearance="outline" class="half-width">
                            <mat-label>ZIP Code</mat-label>
                            <input matInput type="text" formControlName="zipCode" placeholder="12345" required>
                            <mat-error *ngIf="editForm.get('zipCode')?.hasError('required')">ZIP code is required</mat-error>
                            <mat-error *ngIf="editForm.get('zipCode')?.hasError('pattern')">Please enter a valid ZIP code</mat-error>
                        </mat-form-field>

                        <mat-form-field appearance="outline" class="half-width">
                            <mat-label>Delay (minutes)</mat-label>
                            <input matInput type="number" formControlName="delay" min="0" [disabled]="editingUser ? (editingUser.userGroupId || 0) > 0 : false">
                            <mat-hint *ngIf="editingUser && editingUser.userGroupId">Delay is managed by the user's group</mat-hint>
                        </mat-form-field>
                    </div>

                    <div class="form-row">
                        <mat-form-field appearance="outline" class="full-width">
                            <mat-label>User Group</mat-label>
                            <mat-select formControlName="userGroupId">
                                <mat-option [value]="0">No Group (Unassigned)</mat-option>
                                <mat-option *ngFor="let group of availableGroups" [value]="group.id">
                                    {{ group.name }}
                                </mat-option>
                            </mat-select>
                            <mat-hint>Assign user to a group to inherit group settings</mat-hint>
                        </mat-form-field>
                    </div>

                    <div class="form-row pin-row">
                        <mat-form-field appearance="outline" class="half-width">
                            <mat-label>PIN</mat-label>
                            <input matInput type="text" formControlName="pin" placeholder="Leave blank to generate a new PIN">
                        </mat-form-field>
                        <div class="pin-actions">
                            <button mat-stroked-button color="primary" type="button" (click)="requestPinRegeneration()" [disabled]="saving">
                                <mat-icon>autorenew</mat-icon>
                                Regenerate PIN
                            </button>
                        </div>
                    </div>

                    <div class="form-row">
                        <mat-form-field appearance="outline" class="half-width">
                            <mat-label>Connection Limit</mat-label>
                            <input matInput type="number" min="0" formControlName="connectionLimit" placeholder="0 for unlimited">
                            <mat-hint *ngIf="editingUser && editingUser.userGroupId && editingUser.effectiveConnectionLimit">
                                Group limit: {{ editingUser.effectiveConnectionLimit }} (overrides user limit)
                            </mat-hint>
                            <mat-hint *ngIf="!editingUser || !editingUser.userGroupId || !editingUser.effectiveConnectionLimit">
                                User's connection limit (0 = unlimited)
                            </mat-hint>
                        </mat-form-field>

                        <mat-form-field appearance="outline" class="half-width">
                            <mat-label>PIN Expiration</mat-label>
                            <input matInput type="datetime-local" formControlName="pinExpiresAt" placeholder="Leave blank for no expiration">
                            <mat-hint>Leave blank to keep the PIN active indefinitely.</mat-hint>
                        </mat-form-field>
                    </div>

                    <div class="form-section" *ngIf="!editingUser || !editingUser.userGroupId">
                        <h4>System & Talkgroup Access</h4>
                        <p class="mat-caption">
                            This user allows access to <u>
                                <ng-container *ngIf="editForm.get('systems')?.value === '*'">all</ng-container>
                                <ng-container *ngIf="editForm.get('systems')?.value !== '*'">some</ng-container>
                            </u> systems and talkgroups.
                        </p>
                        <button type="button" mat-button color="primary" (click)="selectUserSystems()">
                            <mat-icon>tune</mat-icon>
                            Choose Systems
                        </button>
                    </div>

                    <div class="form-section" *ngIf="!editingUser || !editingUser.userGroupId">
                        <h4>System-Specific Delays</h4>
                        <p class="mat-caption">Override default delay for specific systems. Disabled when user is in a group (group settings apply).</p>
                        <div *ngFor="let entry of systemDelayEntries; let i = index" class="delay-entry">
                            <mat-form-field appearance="outline" class="system-select">
                                <mat-label>System</mat-label>
                                <mat-select [(ngModel)]="entry.systemId" [ngModelOptions]="{standalone: true}">
                                    <mat-option *ngFor="let system of systems" [value]="system.id">
                                        {{ system.label || ('System ' + system.id) }}
                                    </mat-option>
                                </mat-select>
                            </mat-form-field>
                            <mat-form-field appearance="outline" class="delay-input">
                                <mat-label>Delay (minutes)</mat-label>
                                <input matInput type="number" [(ngModel)]="entry.delay" [ngModelOptions]="{standalone: true}" min="0">
                            </mat-form-field>
                            <button mat-icon-button type="button" (click)="removeSystemDelay(i)" color="warn">
                                <mat-icon>delete</mat-icon>
                            </button>
                        </div>
                        <button mat-button type="button" (click)="addSystemDelay()">
                            <mat-icon>add</mat-icon>
                            Add System Delay
                        </button>
                    </div>

                    <div class="form-section" *ngIf="!editingUser || !editingUser.userGroupId">
                        <h4>Talkgroup-Specific Delays</h4>
                        <p class="mat-caption">Override default delay for specific talkgroups. Disabled when user is in a group (group settings apply).</p>
                        <div *ngFor="let entry of talkgroupDelayEntries; let i = index" class="delay-entry">
                            <mat-form-field appearance="outline" class="system-select">
                                <mat-label>System</mat-label>
                                <mat-select [(ngModel)]="entry.systemId" [ngModelOptions]="{standalone: true}" (selectionChange)="entry.talkgroupId = 0">
                                    <mat-option *ngFor="let system of systems" [value]="system.id">
                                        {{ system.label || ('System ' + system.id) }}
                                    </mat-option>
                                </mat-select>
                            </mat-form-field>
                            <mat-form-field appearance="outline" class="talkgroup-select" *ngIf="entry.systemId > 0">
                                <mat-label>Talkgroup</mat-label>
                                <mat-select [(ngModel)]="entry.talkgroupId" [ngModelOptions]="{standalone: true}">
                                    <mat-option *ngFor="let talkgroup of getTalkgroupsForSystem(entry.systemId)" [value]="talkgroup.id">
                                        {{ talkgroup.label || ('Talkgroup ' + talkgroup.id) }}
                                    </mat-option>
                                </mat-select>
                            </mat-form-field>
                            <mat-form-field appearance="outline" class="delay-input">
                                <mat-label>Delay (minutes)</mat-label>
                                <input matInput type="number" [(ngModel)]="entry.delay" [ngModelOptions]="{standalone: true}" min="0">
                            </mat-form-field>
                            <button mat-icon-button type="button" (click)="removeTalkgroupDelay(i)" color="warn">
                                <mat-icon>delete</mat-icon>
                            </button>
                        </div>
                        <button mat-button type="button" (click)="addTalkgroupDelay()">
                            <mat-icon>add</mat-icon>
                            Add Talkgroup Delay
                        </button>
                    </div>

                    <div *ngIf="editingUser && editingUser.userGroupId" class="form-section">
                        <p class="mat-caption" style="color: #666; font-style: italic;">
                            System/talkgroup access and delays are managed by the user's group. Remove the user from the group to configure individual access and delays.
                        </p>
                    </div>

                    <div class="form-section">
                        <h4>Stripe Billing Information</h4>
                        <div class="form-row">
                            <mat-form-field appearance="outline" class="full-width">
                                <mat-label>Stripe Customer ID</mat-label>
                                <input matInput type="text" formControlName="stripeCustomerId" placeholder="cus_...">
                                <mat-hint>Stripe customer ID for billing (e.g., cus_abc123)</mat-hint>
                            </mat-form-field>
                        </div>
                        <div class="form-row">
                            <mat-form-field appearance="outline" class="half-width">
                                <mat-label>Stripe Subscription ID</mat-label>
                                <input matInput type="text" formControlName="stripeSubscriptionId" placeholder="sub_...">
                                <mat-hint>Stripe subscription ID (e.g., sub_abc123)</mat-hint>
                            </mat-form-field>
                            <mat-form-field appearance="outline" class="half-width">
                                <mat-label>Subscription Status</mat-label>
                                <mat-select formControlName="subscriptionStatus">
                                    <mat-option value="">None</mat-option>
                                    <mat-option value="active">Active</mat-option>
                                    <mat-option value="trialing">Trialing</mat-option>
                                    <mat-option value="incomplete">Incomplete</mat-option>
                                    <mat-option value="past_due">Past Due</mat-option>
                                    <mat-option value="canceled">Canceled</mat-option>
                                    <mat-option value="unpaid">Unpaid</mat-option>
                                </mat-select>
                                <mat-hint>Current subscription status</mat-hint>
                            </mat-form-field>
                        </div>
                    </div>

                    <div class="form-row">
                        <mat-checkbox formControlName="verified">Email Verified</mat-checkbox>
                        <mat-checkbox formControlName="isGroupAdmin" [disabled]="!editingUser || !editingUser.userGroupId">
                            Group Admin
                        </mat-checkbox>
                        <mat-checkbox formControlName="systemAdmin">
                            System Admin
                        </mat-checkbox>
                        <mat-hint *ngIf="editingUser && !editingUser.userGroupId" style="display: block; margin-top: 8px; color: #666;">
                            User must be assigned to a group to be a group admin
                        </mat-hint>
                        <mat-hint style="display: block; margin-top: 8px; color: #666;">
                            System admins receive notifications about server health issues and can send system alerts
                        </mat-hint>
                    </div>

                    <div class="form-actions">
                        <button mat-raised-button color="primary" type="button" 
                                (click)="saveUser()" [disabled]="editForm.invalid || saving">
                            <mat-spinner diameter="20" *ngIf="saving"></mat-spinner>
                            <span *ngIf="!saving">Save Changes</span>
                        </button>
                        <button mat-button type="button" (click)="cancelEdit()" [disabled]="saving">
                            Cancel
                        </button>
                    </div>
                </form>

                <!-- Display Mode (shown when not editing) -->
                <div *ngIf="!editingUser || editingUser.id !== user.id">
                    <div class="detail-row">
                        <span class="label">User ID:</span>
                        <span class="value">{{ user.id }}</span>
                    </div>
                    
                    <div class="detail-row">
                        <span class="label">Email:</span>
                        <span class="value">{{ user.email }}</span>
                    </div>
                    
                    <div class="detail-row">
                        <span class="label">First Name:</span>
                        <span class="value">{{ user.firstName || 'Not provided' }}</span>
                    </div>
                    
                    <div class="detail-row">
                        <span class="label">Last Name:</span>
                        <span class="value">{{ user.lastName || 'Not provided' }}</span>
                    </div>
                    
                    <div class="detail-row">
                        <span class="label">ZIP Code:</span>
                        <span class="value">{{ user.zipCode || 'Not provided' }}</span>
                    </div>
                    
                    <div class="detail-row">
                        <span class="label">Group:</span>
                        <span class="value">
                            {{ getGroupName(user.userGroupId) || 'No Group (Unassigned)' }}
                            <mat-chip *ngIf="user.isGroupAdmin" color="primary" selected style="margin-left: 8px;">
                                Group Admin
                            </mat-chip>
                        </span>
                    </div>

                    <div class="detail-row">
                        <span class="label">System Admin:</span>
                        <span class="value">
                            <mat-icon [color]="user.systemAdmin ? 'primary' : ''">
                                {{ user.systemAdmin ? 'check_circle' : 'cancel' }}
                            </mat-icon>
                            {{ user.systemAdmin ? 'Yes' : 'No' }}
                            <mat-chip *ngIf="user.systemAdmin" color="warn" selected style="margin-left: 8px;">
                                System Admin
                            </mat-chip>
                        </span>
                    </div>

                    <div class="detail-row">
                        <span class="label">Verified:</span>
                        <span class="value">
                            <mat-icon [color]="getVerificationStatusColor(user)">
                                {{ user.verified ? 'check_circle' : 'pending' }}
                            </mat-icon>
                            {{ getVerificationStatus(user) }}
                        </span>
                    </div>

                    <div class="detail-row">
                        <span class="label">PIN:</span>
                        <span class="value">{{ user.pin || 'Not assigned' }}</span>
                    </div>

                    <div class="detail-row">
                        <span class="label">PIN Expiration:</span>
                        <span class="value">{{ formatPinExpiration(user.pinExpiresAt) }}</span>
                    </div>

                    <div class="detail-row" *ngIf="user.pinExpired">
                        <span class="label">PIN Status:</span>
                        <span class="value status-warn">
                            <mat-icon color="warn">error</mat-icon>
                            Expired
                        </span>
                    </div>

                    <div class="detail-row">
                        <span class="label">Connection Limit:</span>
                        <span class="value">
                            {{ getConnectionLimitLabel(user.effectiveConnectionLimit ?? user.connectionLimit) }}
                            <span *ngIf="user.userGroupId && user.effectiveConnectionLimit" class="group-limit-hint">
                                (from group)
                            </span>
                        </span>
                    </div>
                    
                    <div class="detail-row">
                        <span class="label">Created:</span>
                        <span class="value">{{ formatDate(user.createdAt) }}</span>
                    </div>
                    
                    <div class="detail-row">
                        <span class="label">Last Login:</span>
                        <span class="value">{{ formatDate(user.lastLogin) }}</span>
                    </div>
                    
                    <div class="detail-row" *ngIf="user.systems">
                        <span class="label">Systems:</span>
                        <span class="value">{{ user.systems }}</span>
                    </div>
                    
                    <div class="detail-row" *ngIf="user.delay > 0">
                        <span class="label">Delay:</span>
                        <span class="value">{{ user.delay }} minutes</span>
                    </div>

                    <div class="detail-row" *ngIf="user.systemDelays">
                        <span class="label">System Delays:</span>
                        <div class="value code-block">
                            <pre>{{ user.systemDelays }}</pre>
                        </div>
                    </div>

                    <div class="detail-row" *ngIf="user.talkgroupDelays">
                        <span class="label">Talkgroup Delays:</span>
                        <div class="value code-block">
                            <pre>{{ user.talkgroupDelays }}</pre>
                        </div>
                    </div>
                </div>
                
                <div class="detail-row" *ngIf="user.stripeCustomerId">
                    <span class="label">Stripe Customer:</span>
                    <span class="value">{{ user.stripeCustomerId }}</span>
                </div>
                
                <div class="detail-row" *ngIf="user.subscriptionStatus">
                    <span class="label">Subscription:</span>
                    <span class="value">{{ user.subscriptionStatus }}</span>
                </div>

                <div class="detail-row" *ngIf="user.fcmTokens && user.fcmTokens.length > 0">
                    <span class="label">FCM Tokens ({{ user.fcmTokens.length }}):</span>
                    <div class="value">
                        <mat-list dense>
                            <mat-list-item *ngFor="let token of user.fcmTokens" style="height: auto; padding: 8px 0;">
                                <div style="display: flex; flex-direction: column; width: 100%;">
                                    <div style="display: flex; align-items: center; margin-bottom: 4px;">
                                        <mat-icon style="font-size: 16px; width: 16px; height: 16px; margin-right: 8px;" 
                                                  [color]="token.platform === 'ios' ? 'primary' : 'accent'">
                                            {{ token.platform === 'ios' ? 'phone_iphone' : 'phone_android' }}
                                        </mat-icon>
                                        <mat-chip style="font-size: 11px; min-height: 24px;">
                                            {{ token.platform | uppercase }} - {{ token.pushType }}
                                        </mat-chip>
                                        <mat-chip style="font-size: 11px; min-height: 24px; margin-left: 4px;">
                                            {{ token.sound || 'default' }}
                                        </mat-chip>
                                    </div>
                                    <code style="font-size: 11px; background: #f5f5f5; padding: 4px 8px; border-radius: 4px; display: block; word-break: break-all; color: #333;">
                                        {{ token.fcmToken }}
                                    </code>
                                    <div style="font-size: 11px; color: #666; margin-top: 4px;">
                                        Created: {{ token.createdAt }} | Last Used: {{ token.lastUsed }}
                                    </div>
                                </div>
                            </mat-list-item>
                        </mat-list>
                    </div>
                </div>

                <div class="actions" *ngIf="!editingUser || editingUser.id !== user.id">
                    <button type="button" mat-button color="accent" 
                            (click)="startEdit(user)">
                        <mat-icon>edit</mat-icon>
                        Edit User
                    </button>
                    
                    <button type="button" mat-button color="primary" 
                            (click)="openTransferDialog(user)">
                        <mat-icon>swap_horiz</mat-icon>
                        Transfer to Group
                    </button>
                    
                    <button type="button" mat-button color="primary" 
                            (click)="openResetPasswordDialog(user)">
                        <mat-icon>lock_reset</mat-icon>
                        Reset Password
                    </button>
                    
                    <button type="button" mat-button color="accent" 
                            (click)="sendTestPush(user)">
                        <mat-icon>notifications</mat-icon>
                        Send Test Push
                    </button>
                    
                    <button type="button" mat-button color="primary" 
                            (click)="resendVerificationEmail(user)"
                            *ngIf="!user.verified">
                        <mat-icon>email</mat-icon>
                        Resend Verification
                    </button>
                    
                    <button type="button" mat-button color="warn" 
                            (click)="deleteUser(user)">
                        <mat-icon>delete</mat-icon>
                        Delete User
                    </button>
                </div>
            </div>
        </mat-expansion-panel>
    </mat-accordion>

    <!-- Paginator -->
    <mat-paginator 
        *ngIf="!loading && !error && users.length > 0"
        [length]="filteredUsers.length"
        [pageSize]="pageSize"
        [pageSizeOptions]="[10, 25, 50, 100]"
        (page)="onPageChange($event)"
        showFirstLastButtons
        class="users-paginator">
    </mat-paginator>
</div>
