<div class="system-health-container">
    <div class="stats-grid">
        <div class="stat-card">
            <h3>Total Alerts</h3>
            <div class="value">{{ stats.total }}</div>
        </div>
        <div class="stat-card critical">
            <h3>Critical</h3>
            <div class="value">{{ stats.critical }}</div>
        </div>
        <div class="stat-card error">
            <h3>Errors</h3>
            <div class="value">{{ stats.error }}</div>
        </div>
        <div class="stat-card warning">
            <h3>Warnings</h3>
            <div class="value">{{ stats.warning }}</div>
        </div>
    </div>

    <!-- Settings Section -->
    <mat-card class="settings-section">
        <mat-card-header>
            <mat-card-title>Settings</mat-card-title>
        </mat-card-header>
        <mat-card-content>
            <div class="settings-grid">
                <div class="setting-item">
                    <label>Transcription Failure Alert Threshold:</label>
                    <div class="setting-control">
                        <span *ngIf="!editingThreshold" class="setting-value">{{ transcriptionFailureThreshold }} failures</span>
                        <div *ngIf="editingThreshold" class="setting-edit">
                            <mat-form-field appearance="outline" class="threshold-input">
                                <input matInput type="number" [(ngModel)]="newThreshold" min="1">
                            </mat-form-field>
                            <button mat-icon-button color="primary" (click)="saveThreshold()" title="Save">
                                <mat-icon>check</mat-icon>
                            </button>
                            <button mat-icon-button (click)="cancelEditThreshold()" title="Cancel">
                                <mat-icon>close</mat-icon>
                            </button>
                        </div>
                        <button *ngIf="!editingThreshold" mat-icon-button (click)="editingThreshold = true; newThreshold = transcriptionFailureThreshold" title="Edit threshold">
                            <mat-icon>edit</mat-icon>
                        </button>
                    </div>
                    <span class="setting-description">Alert will be triggered when this many transcription failures occur in 24 hours</span>
                </div>
                <div class="setting-item">
                    <label>Tone Detection Issue Threshold:</label>
                    <div class="setting-control">
                        <span *ngIf="!editingToneThreshold" class="setting-value">{{ toneDetectionIssueThreshold }} calls</span>
                        <div *ngIf="editingToneThreshold" class="setting-edit">
                            <mat-form-field appearance="outline" class="threshold-input">
                                <input matInput type="number" [(ngModel)]="newToneThreshold" min="1">
                            </mat-form-field>
                            <button mat-icon-button color="primary" (click)="saveToneDetectionThreshold()" title="Save">
                                <mat-icon>check</mat-icon>
                            </button>
                            <button mat-icon-button (click)="cancelEditToneThreshold()" title="Cancel">
                                <mat-icon>close</mat-icon>
                            </button>
                        </div>
                        <button *ngIf="!editingToneThreshold" mat-icon-button (click)="editingToneThreshold = true; newToneThreshold = toneDetectionIssueThreshold" title="Edit threshold">
                            <mat-icon>edit</mat-icon>
                        </button>
                    </div>
                    <span class="setting-description">Alert will be triggered when a talkgroup with tone detection enabled has this many calls with no tones detected in 24 hours</span>
                </div>
                <div class="setting-item">
                    <label>Alert Retention Days:</label>
                    <div class="setting-control">
                        <span *ngIf="!editingRetentionDays" class="setting-value">{{ alertRetentionDays }} days</span>
                        <div *ngIf="editingRetentionDays" class="setting-edit">
                            <mat-form-field appearance="outline" class="threshold-input">
                                <input matInput type="number" [(ngModel)]="newRetentionDays" min="1">
                            </mat-form-field>
                            <button mat-icon-button color="primary" (click)="saveRetentionDays()" title="Save">
                                <mat-icon>check</mat-icon>
                            </button>
                            <button mat-icon-button (click)="cancelEditRetentionDays()" title="Cancel">
                                <mat-icon>close</mat-icon>
                            </button>
                        </div>
                        <button *ngIf="!editingRetentionDays" mat-icon-button (click)="editingRetentionDays = true; newRetentionDays = alertRetentionDays" title="Edit retention days">
                            <mat-icon>edit</mat-icon>
                        </button>
                    </div>
                    <span class="setting-description">System alerts and logs will be automatically deleted after this many days</span>
                </div>
            </div>
        </mat-card-content>
    </mat-card>

    <div class="alerts-section">
        <div class="alerts-header">
            <h2>System Alerts</h2>
            <button mat-raised-button color="primary" (click)="loadAlerts()" [disabled]="loading">
                <mat-icon>refresh</mat-icon>
                Refresh
            </button>
        </div>

        <div *ngIf="loading" class="loading">
            <mat-spinner diameter="40"></mat-spinner>
            <p>Loading alerts...</p>
        </div>

        <div *ngIf="error" class="error-message">
            <mat-icon>error</mat-icon>
            <span>{{ error }}</span>
        </div>

        <div *ngIf="!loading && !error && alerts.length === 0" class="no-alerts">
            <mat-icon>check_circle</mat-icon>
            <p>No alerts found</p>
        </div>

        <div *ngIf="!loading && !error && alerts.length > 0" class="alerts-list">
            <div *ngFor="let alert of alerts" class="alert-item" [ngClass]="alert.severity">
                <div class="alert-header">
                    <div class="alert-title-section">
                        <div class="alert-title">
                            <span class="alert-icon">{{ getSeverityIcon(alert.severity) }}</span>
                            {{ alert.title }}
                        </div>
                        <div class="alert-meta">
                            <span class="alert-type">{{ alert.alertType }}</span>
                            <span class="alert-severity">{{ alert.severity }}</span>
                        </div>
                    </div>
                    <div class="alert-time">{{ formatDate(alert.createdAt) }}</div>
                </div>
                <div class="alert-message">{{ alert.message }}</div>
                <div *ngIf="hasAlertData(alert)" class="alert-data">
                    <pre>{{ getAlertData(alert) | json }}</pre>
                </div>

                <!-- Transcription Failure Details -->
                <div *ngIf="alert.alertType === 'transcription_failure'" class="transcription-failure-details">
                    <div class="failure-controls">
                        <button mat-raised-button color="warn" (click)="resetFailures()" [disabled]="loadingFailedCalls">
                            <mat-icon>refresh</mat-icon>
                            Reset All Failures
                        </button>
                    </div>

                    <div *ngIf="loadingFailedCalls" class="loading-calls">
                        <mat-spinner diameter="30"></mat-spinner>
                        <span>Loading failed calls...</span>
                    </div>

                    <div *ngIf="!loadingFailedCalls && failedCalls.length > 0" class="failed-calls-list">
                        <h4>Failed Calls ({{ failedCalls.length }}):</h4>
                        <div class="failed-call-item" *ngFor="let call of failedCalls">
                            <div class="call-info">
                                <div class="call-header">
                                    <strong>Call #{{ call.callId }}</strong>
                                    <span class="call-time">{{ formatDate(call.timestamp) }}</span>
                                </div>
                                <div class="call-details">
                                    <span *ngIf="call.systemLabel">{{ call.systemLabel }}</span>
                                    <span *ngIf="call.systemLabel && call.talkgroupLabel"> / </span>
                                    <span *ngIf="call.talkgroupLabel">{{ call.talkgroupLabel }}</span>
                                    <span *ngIf="call.talkgroupName && call.talkgroupLabel"> ({{ call.talkgroupName }})</span>
                                </div>
                                <div *ngIf="call.failureReason" class="failure-reason">
                                    <mat-icon class="error-icon">error</mat-icon>
                                    <span class="failure-text">{{ call.failureReason }}</span>
                                </div>
                            </div>
                            <button mat-stroked-button (click)="playCall(call.callId)" [title]="isPlaying(call.callId) ? 'Stop' : 'Play'">
                                <mat-icon>{{ isPlaying(call.callId) ? 'pause' : 'play_arrow' }}</mat-icon>
                                {{ isPlaying(call.callId) ? 'Stop' : 'Play' }}
                            </button>
                        </div>
                    </div>

                    <div *ngIf="!loadingFailedCalls && failedCalls.length === 0" class="no-failed-calls">
                        <mat-icon>check_circle</mat-icon>
                        <span>No failed calls found</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

