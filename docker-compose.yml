# ThinLine Radio - Docker Compose Configuration
# This file orchestrates ThinLine Radio server and PostgreSQL database
# 
# Usage:
#   Start:    docker-compose up -d
#   Stop:     docker-compose down
#   Logs:     docker-compose logs -f
#   Rebuild:  docker-compose up -d --build
#
# Before starting:
#   1. Copy .env.docker.example to .env
#   2. Edit .env with your configuration
#   3. Review and adjust volume paths below if needed

version: '3.8'

services:
  # =============================================================================
  # PostgreSQL Database
  # =============================================================================
  postgres:
    image: postgres:16-alpine
    container_name: thinline-postgres
    restart: unless-stopped
    
    environment:
      # PostgreSQL configuration from .env file
      POSTGRES_DB: ${DB_NAME:-thinline_radio}
      POSTGRES_USER: ${DB_USER:-thinline_user}
      POSTGRES_PASSWORD: ${DB_PASS:?Database password must be set in .env file}
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=en_US.UTF-8"
      
      # Performance tuning
      POSTGRES_MAX_CONNECTIONS: 200
      
    volumes:
      # Persist database data
      - postgres_data:/var/lib/postgresql/data
      
      # Optional: Custom initialization scripts
      # Place .sql or .sh files in ./docker/init-db/ to run on first startup
      - ./docker/init-db:/docker-entrypoint-initdb.d:ro
    
    ports:
      # Expose PostgreSQL port (optional, for external access)
      # Comment out if you don't need external database access
      - "5432:5432"
    
    networks:
      - thinline_network
    
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-thinline_user} -d ${DB_NAME:-thinline_radio}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    
    # Resource limits (adjust based on your server capacity)
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

  # =============================================================================
  # ThinLine Radio Server
  # =============================================================================
  thinline-radio:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - BUILD_DATE=${BUILD_DATE:-unknown}
        - VERSION=${VERSION:-7.0.0}
    
    container_name: thinline-radio
    restart: unless-stopped
    
    depends_on:
      postgres:
        condition: service_healthy
    
    environment:
      # Database configuration
      DB_TYPE: postgresql
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: ${DB_NAME:-thinline_radio}
      DB_USER: ${DB_USER:-thinline_user}
      DB_PASS: ${DB_PASS}
      
      # Server configuration
      LISTEN: 0.0.0.0:3000
      SSL_LISTEN: 0.0.0.0:3443
      
      # Optional: SSL configuration (uncomment if using SSL)
      # SSL_AUTO_CERT: ${SSL_AUTO_CERT}
      # SSL_CERT_FILE: /app/config/ssl/cert.pem
      # SSL_KEY_FILE: /app/config/ssl/key.pem
      
      # Optional: Transcription services (uncomment and configure as needed)
      # GOOGLE_APPLICATION_CREDENTIALS: /app/config/google-credentials.json
      # AZURE_SPEECH_KEY: ${AZURE_SPEECH_KEY}
      # AZURE_SPEECH_REGION: ${AZURE_SPEECH_REGION}
      # WHISPER_API_KEY: ${WHISPER_API_KEY}
      # ASSEMBLYAI_API_KEY: ${ASSEMBLYAI_API_KEY}
      
      # Optional: Email configuration
      # SMTP_HOST: ${SMTP_HOST}
      # SMTP_PORT: ${SMTP_PORT}
      # SMTP_USER: ${SMTP_USER}
      # SMTP_PASS: ${SMTP_PASS}
      # SMTP_FROM: ${SMTP_FROM}
      
      # Optional: Stripe billing
      # STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY}
      # STRIPE_PUBLISHABLE_KEY: ${STRIPE_PUBLISHABLE_KEY}
      # STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET}
      
      # System configuration
      TZ: ${TZ:-America/New_York}
    
    volumes:
      # Configuration files
      - ./docker/config:/app/config:ro
      
      # Data storage (audio files, database files, etc.)
      # WARNING: This can grow large - ensure sufficient disk space
      - thinline_data:/app/data
      
      # Logs (optional)
      - thinline_logs:/app/logs
      
      # Optional: SSL certificates
      # - ./docker/ssl:/app/config/ssl:ro
      
      # Optional: Transcription service credentials
      # - ./docker/credentials:/app/config/credentials:ro
    
    ports:
      # HTTP port
      - "${HTTP_PORT:-3000}:3000"
      
      # HTTPS port (optional, if SSL configured)
      - "${HTTPS_PORT:-3443}:3443"
    
    networks:
      - thinline_network
    
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    # Resource limits (adjust based on your server capacity)
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 1G
    
    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# =============================================================================
# Networks
# =============================================================================
networks:
  thinline_network:
    driver: bridge

# =============================================================================
# Volumes
# =============================================================================
volumes:
  # PostgreSQL data - persistent database storage
  postgres_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${DATA_PATH:-./docker/data}/postgres
  
  # ThinLine Radio data - audio files and application data
  thinline_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${DATA_PATH:-./docker/data}/thinline
  
  # Application logs
  thinline_logs:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${DATA_PATH:-./docker/data}/logs

